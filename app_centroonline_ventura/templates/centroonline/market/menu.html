{% extends 'centroonline/base.html' %}

{% block title %}Productos Disponibles{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-5 bg-light rounded-4 mb-5 animate__animated animate__fadeIn">
    <div class="row align-items-center">
        <div class="col-lg-6">
            <h1 class="display-5 fw-bold text-gradient-primary mb-3">Explora Nuestros Productos</h1>
            <p class="lead text-muted mb-4">Descubre una selección cuidadosamente curada de productos de alta calidad para todas tus necesidades.</p>
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-lg px-4 rounded-pill" data-bs-toggle="modal" data-bs-target="#filtrosModal">
                    <i class="bi bi-sliders me-2"></i>Filtrar
                </button>
                <div class="vr d-none d-md-block"></div>
                <div class="d-flex align-items-center text-muted">
                    <i class="bi bi-stars me-2 fs-5 text-warning"></i>
                    <small>+10,000 clientes satisfechos</small>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mt-4 mt-lg-0">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="card-body p-4">
                    <form method="get" action="" class="search-form">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="search" name="q" class="form-control border-start-0 ps-0" 
                                   placeholder="Buscar productos..." aria-label="Buscar productos"
                                   x-data="{}" 
                                   @keyup.debounce.500ms="$event.target.form.submit()">
                            <button class="btn btn-primary px-4" type="submit">
                                Buscar
                            </button>
                        </div>
                    </form>
                    <div class="d-flex justify-content-between mt-3">
                        <small class="text-muted">{{ productos.count }} productos encontrados</small>
                        <small class="text-primary">
                            <i class="bi bi-lightning-charge-fill"></i> ¡Envíos rápidos!
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros rápidos -->
<div class="mb-4">
    <div class="d-flex flex-wrap gap-2">
        <a href="?orden=precio_asc" class="btn btn-sm btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-up"></i> Precio
        </a>
        <a href="?orden=precio_desc" class="btn btn-sm btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-down"></i> Precio
        </a>
        <a href="?nuevo=1" class="btn btn-sm btn-outline-danger rounded-pill">
            <i class="bi bi-star-fill"></i> Nuevos
        </a>
        {% for cat in categorias|slice:":5" %}
        <a href="?categoria={{ cat.id }}" class="btn btn-sm btn-outline-primary rounded-pill">
            {{ cat.nombre }}
        </a>
        {% endfor %}
    </div>
</div>

<!-- Productos -->
<div class="row g-4" id="productos-container">
    {% for producto in productos %}
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card h-100 product-card border-0 shadow-sm hover-lift hover-shadow transition-all animate__animated animate__fadeIn">
            <div class="position-relative overflow-hidden rounded-top-3">
                <img src="{{ producto.imagen_principal.url }}" 
                     class="card-img-top img-fluid product-image" 
                     alt="{{ producto.nombre }}"
                     loading="lazy">
                <div class="product-badges">
                    {% if producto.nuevo %}
                    <span class="badge bg-danger bg-opacity-90 rounded-pill px-3 py-2 shadow-sm animate__animated animate__pulse animate__infinite">
                        <i class="bi bi-star-fill me-1"></i> Nuevo
                    </span>
                    {% endif %}
                    {% if producto.descuento %}
                    <span class="badge bg-success bg-opacity-90 rounded-pill px-3 py-2 shadow-sm">
                        -{{ producto.descuento }}%
                    </span>
                    {% endif %}
                </div>
                <div class="product-actions">
                    <button class="btn btn-sm btn-light rounded-circle shadow-sm" 
                            data-bs-toggle="tooltip" data-bs-title="Agregar a favoritos">
                        <i class="bi bi-heart"></i>
                    </button>
                    <button class="btn btn-sm btn-light rounded-circle shadow-sm"
                            onclick="quickView({{ producto.pk }})"
                            data-bs-toggle="tooltip" data-bs-title="Vista rápida">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>
            <div class="card-body pb-2">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0 text-truncate">{{ producto.nombre }}</h5>
                    <span class="badge bg-info bg-opacity-10 text-info">{{ producto.categoria.nombre }}</span>
                </div>
                <p class="text-muted small mb-2">
                    <i class="bi bi-tag-fill text-primary me-1"></i> 
                    {{ producto.marca|default:"Genérico" }}
                </p>
                
                <div class="d-flex align-items-center mb-2">
                    <div class="star-rating me-2">
                        {% for i in "12345" %}
                            {% if forloop.counter <= producto.valoracion|default:0 %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-star text-muted"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <small class="text-muted">({{ producto.reviews|default:0 }})</small>
                </div>
                
                {% if producto.descuento %}
                <div class="d-flex align-items-center">
                    <h4 class="text-danger mb-0 me-2">${{ producto.precio_descuento|floatformat:2 }}</h4>
                    <del class="text-muted small">${{ producto.precio|floatformat:2 }}</del>
                    <span class="badge bg-danger bg-opacity-10 text-danger ms-auto">
                        Ahorra ${{ producto.ahorro|floatformat:2 }}
                    </span>
                </div>
                {% else %}
                <h4 class="text-primary mb-0">${{ producto.precio|floatformat:2 }}</h4>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent border-0 pt-0">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-{% if producto.stock > 0 %}success{% else %}danger{% endif %}-subtle text-{% if producto.stock > 0 %}success{% else %}danger{% endif %}">
                        <i class="bi bi-{% if producto.stock > 0 %}check-circle{% else %}x-circle{% endif %}-fill me-1"></i>
                        {% if producto.stock > 0 %}{{ producto.stock }} disponibles{% else %}Agotado{% endif %}
                    </span>
                    <span class="text-muted small">
                        <i class="bi bi-truck me-1"></i> Envío {% if producto.envio_gratis %}gratis{% else %}$5.99{% endif %}
                    </span>
                </div>
                <div class="d-grid gap-2">
                    <a href="{% url 'detalle_producto' producto.pk %}" 
                       class="btn btn-outline-primary rounded-pill">
                        <i class="bi bi-eye-fill me-2"></i>Ver detalles
                    </a>
                    <button class="btn btn-primary rounded-pill add-to-cart" 
                            data-product-id="{{ producto.pk }}"
                            {% if producto.stock <= 0 %}disabled{% endif %}>
                        <i class="bi bi-cart-plus-fill me-2"></i>
                        {% if producto.stock > 0 %}Añadir al carrito{% else %}No disponible{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="card shadow-sm border-0 text-center py-5">
            <div class="card-body">
                <i class="bi bi-emoji-frown display-4 text-muted mb-4"></i>
                <h3 class="text-muted">No encontramos productos</h3>
                <p class="text-muted mb-4">Intenta con otros términos de búsqueda o filtros diferentes</p>
                <a href="?" class="btn btn-primary rounded-pill px-4">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>Reiniciar búsqueda
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Paginación -->
{% if is_paginated %}
<nav aria-label="Paginación" class="mt-5">
    <ul class="pagination justify-content-center flex-wrap">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link rounded-start-pill" href="?page=1" aria-label="Primero">
                <i class="bi bi-chevron-double-left"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Siguiente">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link rounded-end-pill" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Último">
                <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Modal de Filtros -->
<div class="modal fade" id="filtrosModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-sliders2 me-2"></i>Filtros Avanzados
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form method="get" id="filters-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Rango de Precio</label>
                            <div class="d-flex align-items-center">
                                <input type="number" class="form-control" name="precio_min" placeholder="Mín" min="0">
                                <span class="mx-2">—</span>
                                <input type="number" class="form-control" name="precio_max" placeholder="Máx" min="0">
                            </div>
                            <div class="mt-3">
                                <div id="price-slider" class="slider-range"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Categorías</label>
                            <div class="category-select">
                                {% for categoria in categorias %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="categoria" 
                                           value="{{ categoria.id }}" id="cat-{{ categoria.id }}">
                                    <label class="form-check-label" for="cat-{{ categoria.id }}">
                                        {{ categoria.nombre }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Marcas</label>
                            <select class="form-select" name="marca" multiple>
                                {% for marca in marcas %}
                                <option value="{{ marca.id }}">{{ marca.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Ordenar por</label>
                            <select class="form-select" name="orden">
                                <option value="">Recomendados</option>
                                <option value="precio_asc">Precio: Menor a Mayor</option>
                                <option value="precio_desc">Precio: Mayor a Menor</option>
                                <option value="nombre_asc">Nombre (A-Z)</option>
                                <option value="nombre_desc">Nombre (Z-A)</option>
                                <option value="valoracion">Mejor valorados</option>
                                <option value="nuevo">Más recientes</option>
                                <option value="vendidos">Más vendidos</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="envio_gratis" id="envio-gratis">
                                <label class="form-check-label" for="envio-gratis">
                                    Solo envío gratis
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="solo_nuevos" id="solo-nuevos">
                                <label class="form-check-label" for="solo-nuevos">
                                    Solo productos nuevos
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="solo_oferta" id="solo-oferta">
                                <label class="form-check-label" for="solo-oferta">
                                    Solo productos en oferta
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="submit" form="filters-form" class="btn btn-primary rounded-pill">
                    <i class="bi bi-funnel-fill me-2"></i>Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick View Modal -->
<div class="modal fade" id="quickViewModal" tabindex="-1" aria-hidden="true">
    <!-- Contenido dinámico se cargará aquí via AJAX -->
</div>

{% endblock %}

{% block extra_js %}
<script>
// Efecto hover para las tarjetas de producto
document.querySelectorAll('.product-card').forEach(card => {
    card.addEventListener('mouseenter', () => {
        card.classList.add('shadow-lg');
        card.querySelector('.product-image').style.transform = 'scale(1.05)';
    });
    card.addEventListener('mouseleave', () => {
        card.classList.remove('shadow-lg');
        card.querySelector('.product-image').style.transform = 'scale(1)';
    });
});

// Función para vista rápida
function quickView(productId) {
    fetch(`/productos/${productId}/quickview/`)
        .then(response => response.text())
        .then(html => {
            const modal = document.getElementById('quickViewModal');
            modal.querySelector('.modal-content').innerHTML = html;
            new bootstrap.Modal(modal).show();
        });
}

// Función para añadir al carrito
document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', function() {
        const productId = this.dataset.productId;
        fetch(`/carrito/agregar/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // Mostrar notificación
                const toast = new bootstrap.Toast(document.getElementById('cartToast'));
                document.getElementById('cartCount').innerText = data.cart_count;
                toast.show();
                
                // Efecto de animación
                const button = this;
                button.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Añadido';
                button.classList.add('btn-success');
                setTimeout(() => {
                    button.innerHTML = '<i class="bi bi-cart-plus-fill me-2"></i>Añadir al carrito';
                    button.classList.remove('btn-success');
                }, 2000);
            }
        });
    });
});

// Inicializar tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Slider de precios (usando noUiSlider si está disponible)
if (typeof noUiSlider !== 'undefined') {
    const priceSlider = document.getElementById('price-slider');

    
    noUiSlider.create(priceSlider, {
        start: [minPrice, maxPrice],
        connect: true,
        range: {
            'min': minPrice,
            'max': maxPrice
        },
        step: 10,
        tooltips: [true, true],
        format: {
            to: function(value) {
                return '$' + Math.round(value);
            },
            from: function(value) {
                return Number(value.replace('$', ''));
            }
        }
    });
    
    priceSlider.noUiSlider.on('update', function(values, handle) {
        const inputs = ['precio_min', 'precio_max'];
        document.getElementsByName(inputs[handle])[0].value = Math.round(values[handle]);
    });
</script>

<style>
/* Estilos personalizados */
.text-gradient-primary {
    background: linear-gradient(90deg, #0d6efd, #6610f2);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
}

.product-card {
    transition: all 0.3s ease;
    border-radius: 0.75rem;
}

.product-card:hover {
    transform: translateY(-5px);
}

.product-image {
    transition: transform 0.5s ease;
    height: 200px;
    object-fit: contain;
    background: #f8f9fa;
}

.product-badges {
    position: absolute;
    top: 10px;
    left: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.product-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.product-card:hover .product-actions {
    opacity: 1;
}

.star-rating {
    color: #ffc107;
    font-size: 0.9rem;
}

.slider-range {
    height: 6px;
    background: #dee2e6;
    border-radius: 3px;
    margin-top: 10px;
}

.category-select {
    max-height: 200px;
    overflow-y: auto;
    padding-right: 10px;
}

.search-form .form-control:focus {
    box-shadow: none;
    border-color: #0d6efd;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .product-actions {
        opacity: 1;
    }
}
</style>
{% endblock %}